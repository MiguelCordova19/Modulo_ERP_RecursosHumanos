<!-- Modal de Cambio de Contraseña Obligatorio -->
<div class="modal fade" id="modalCambioPasswordObligatorio" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalCambioPasswordLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalCambioPasswordLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Cambio de Contraseña Obligatorio
                </h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Primer inicio de sesión detectado.</strong><br>
                    Por seguridad, debe cambiar su contraseña antes de continuar.
                </div>
                
                <form id="formCambioPassword">
                    <div class="mb-3">
                        <label for="passwordActual" class="form-label">Contraseña Actual: <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="passwordActual" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordField('passwordActual', 'iconPasswordActual')">
                                <i class="fas fa-eye" id="iconPasswordActual"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="passwordNueva" class="form-label">Nueva Contraseña: <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="passwordNueva" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordField('passwordNueva', 'iconPasswordNueva')">
                                <i class="fas fa-eye" id="iconPasswordNueva"></i>
                            </button>
                        </div>
                        <small class="text-muted">Mínimo 6 caracteres</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="passwordConfirmar" class="form-label">Confirmar Nueva Contraseña: <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="passwordConfirmar" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordField('passwordConfirmar', 'iconPasswordConfirmar')">
                                <i class="fas fa-eye" id="iconPasswordConfirmar"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-shield-alt me-2"></i>
                        <strong>Recomendaciones:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Use al menos 8 caracteres</li>
                            <li>Combine letras mayúsculas y minúsculas</li>
                            <li>Incluya números y caracteres especiales</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="cambiarPasswordObligatorio()">
                    <i class="fas fa-check me-1"></i>
                    Cambiar Contraseña
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Función para toggle de visibilidad de contraseña
function togglePasswordField(fieldId, iconId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(iconId);
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Función para cambiar contraseña obligatoriamente
async function cambiarPasswordObligatorio() {
    const passwordActual = document.getElementById('passwordActual').value;
    const passwordNueva = document.getElementById('passwordNueva').value;
    const passwordConfirmar = document.getElementById('passwordConfirmar').value;
    
    // Validaciones
    if (!passwordActual || !passwordNueva || !passwordConfirmar) {
        showNotification('Todos los campos son obligatorios', 'danger');
        return;
    }
    
    if (passwordNueva.length < 6) {
        showNotification('La nueva contraseña debe tener al menos 6 caracteres', 'danger');
        return;
    }
    
    if (passwordNueva !== passwordConfirmar) {
        showNotification('Las contraseñas no coinciden', 'danger');
        return;
    }
    
    if (passwordActual === passwordNueva) {
        showNotification('La nueva contraseña debe ser diferente a la actual', 'danger');
        return;
    }
    
    // Obtener datos del usuario
    const user = localStorage.getItem('user');
    if (!user) {
        showNotification('Error: No se encontró información del usuario', 'danger');
        return;
    }
    
    const userData = JSON.parse(user);
    const usuarioId = userData.id || userData.usuario_id;
    
    // Deshabilitar botón
    const btn = event.target;
    const textoOriginal = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Cambiando...';
    btn.disabled = true;
    
    try {
        // Usar el nuevo endpoint que valida la contraseña actual
        const response = await fetch(`http://localhost:3000/api/usuarios/${usuarioId}/cambiar-password-validado`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                passwordActual: passwordActual,
                passwordNueva: passwordNueva
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Contraseña cambiada exitosamente', 'success');
            
            // Actualizar el usuario en localStorage para quitar el flag de primerLogin
            userData.primerLogin = 0;
            userData.primer_login = 0;
            localStorage.setItem('user', JSON.stringify(userData));
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCambioPasswordObligatorio'));
            if (modal) {
                modal.hide();
            }
            
            // Recargar la página para continuar normalmente
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(result.message || 'Error al cambiar contraseña', 'danger');
        }
    } catch (error) {
        console.error('Error al cambiar contraseña:', error);
        showNotification('Error al conectar con el servidor', 'danger');
    } finally {
        btn.innerHTML = textoOriginal;
        btn.disabled = false;
    }
}

// Función de notificaciones
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>
